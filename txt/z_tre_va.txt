z_tre_va01:--z_tre_va01

declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
declare @t_po nvarchar(20)

set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bdriverno = case when '#non'=[5] then '' else [5] end
set @t_edriverno = case when '#non'=[6] then char(255) else [6] end
set @t_po = case when '#non'=[7] then '' else [7] end

---------------------------------------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	mon nvarchar(30),
	driverno nvarchar(20),
	driver nvarchar(20),
	tel nvarchar(20),
	trandate nvarchar(10),
	po nvarchar(20),
	carno nvarchar(20),
	product nvarchar(40),
	straddr nvarchar(50),
	endaddr nvarchar(50),
    mount float,
	price float,	
	money float,
	carchgno nvarchar(max),
	item nvarchar(max),
	plusmoney float,
	minusmoney float,
	memo nvarchar(200)
)

insert into @tmp
select '0',c.mon,c.driverno,c.driver,
	   case when LEN(d.tel) = 0 then d.mobile else d.tel end,
	   c.trandate,c.po,c.carno,c.product,c.straddr,c.endaddr,c.mount,c.price3,c.total2,a.carchgno,'',0,0,a.memo
from view_tre a
left join view_tres b on a.noa = b.noa  
left join view_trans c on b.tranno = c.noa and b.trannoq = c.noq
left join driver d on a.driver = d.namea
where (a.datea between @t_bdate and @t_edate) and (a.driverno between @t_bdriverno and @t_edriverno) and (LEN(@t_po)=0 or c.po = @t_po)

declare @mon nvarchar(30)
declare @driverno nvarchar(20)
declare @carchgno nvarchar(max)
declare @xcarchgno nvarchar(max)
declare @str nvarchar(max)
declare @sub nvarchar(max)
declare @date nvarchar(10)
declare @pitem nvarchar(10)
declare @mitem nvarchar(10)
declare @pmny float
declare @mmny float
declare @memo nvarchar(200) 

set @xcarchgno = 'zzzzzzzzzzzz'

declare cursor_table cursor for 
select mon,driverno,carchgno from @tmp where gno = '0'
open cursor_table 
fetch next from cursor_table 
into @mon,@driverno,@carchgno
while(@@FETCH_STATUS <> -1) 
begin	
	if(@xcarchgno != @carchgno and LEN(@carchgno) = 12)
	begin
		set @str = @carchgno 
		set @date = (select datea from carchg where noa = @str)
		set @pitem = (select plusitem from carchg where noa = @str)
		set @mitem = (select minusitem from carchg where noa = @str)
		set @pmny = (select plusmoney from carchg where noa = @str)
		set @mmny = (select minusmoney from carchg where noa = @str)
		set @memo = (select memo from carchg where noa = @str)
		insert into @tmp(gno,mon,driverno,trandate,carchgno,item,plusmoney,minusmoney,memo)
		values('2',@mon,@driverno,@date,@carchgno,@pitem+@mitem,@pmny,@mmny,@memo)
		set @xcarchgno = @carchgno
	end
	else if(@xcarchgno != @carchgno and LEN(@carchgno) > 12)
	begin
		set @str = @carchgno 
		while (LEN(@str) > 0)
		begin
			set @sub = SUBSTRING(@str,1,12)						
			
			if(LEN(@str) > 12)
			begin
				set @date = (select datea from carchg where noa = @sub)
				set @pitem = (select plusitem from carchg where noa = @sub)
				set @mitem = (select minusitem from carchg where noa = @sub)
				set @pmny = (select plusmoney from carchg where noa = @sub)
				set @mmny = (select minusmoney from carchg where noa = @sub)
				set @memo = (select memo from carchg where noa = @sub)
				insert into @tmp(gno,mon,driverno,trandate,carchgno,item,plusmoney,minusmoney,memo)
				values('2',@mon,@driverno,@date,@sub,@pitem+@mitem,@pmny,@mmny,@memo)
				set @str = RIGHT(@str,LEN(@str)-13)	
			end
			else if(LEN(@str) = 12)
			begin
				set @date = (select datea from carchg where noa = @sub)
				set @pitem = (select plusitem from carchg where noa = @sub)
				set @mitem = (select minusitem from carchg where noa = @sub)
				set @pmny = (select plusmoney from carchg where noa = @sub)
				set @mmny = (select minusmoney from carchg where noa = @sub)
				set @memo = (select memo from carchg where noa = @sub)
				insert into @tmp(gno,mon,driverno,trandate,carchgno,item,plusmoney,minusmoney,memo)
				values('2',@mon,@driverno,@date,@sub,@pitem+@mitem,@pmny,@mmny,@memo)			
				set @str = ''
			end
			set @xcarchgno = @carchgno			
		end
	end
	else if (@xcarchgno = @carchgno)
	begin
		 set @xcarchgno = @carchgno	
	end

	fetch next from cursor_table 
	into @mon,@driverno,@carchgno
end 
close cursor_table 
deallocate cursor_table

insert into @tmp(gno,mon,driverno,money)
select '3',mon,driverno,SUM(money)
from @tmp where gno = '0' group by gno,mon,driverno

declare @xmon nvarchar(30)
declare @xdriverno nvarchar(20)
declare @plusmoney float
declare @minusmoney float
declare @totpmny float
declare @totmmny float
declare @cnt float

set @xmon = 'zzzzzz'
set @xdriverno = 'xxxx'

declare cursor_table cursor for 
select mon,driverno,plusmoney,minusmoney from @tmp where gno = '2'
open cursor_table 
fetch next from cursor_table 
into @mon,@driverno,@plusmoney,@minusmoney
while(@@FETCH_STATUS <> -1) 
begin
	if(@xmon != @mon or @xdriverno != @driverno)
	begin
		set @cnt = (select COUNT(*) from @tmp where gno = '2' and mon = @mon and driverno = @driverno)
		set @totpmny = 0
		set @totmmny = 0 
		set @totpmny = @totpmny + @plusmoney
		set @totmmny = @totmmny + @minusmoney
		set @cnt = @cnt - 1
		set @xmon = @mon
		set @xdriverno = @driverno
	end
	else if (@xmon = @mon and @xdriverno = @driverno)
	begin
		set @totpmny = @totpmny + @plusmoney
		set @totmmny = @totmmny + @minusmoney
		set @cnt = @cnt - 1
		set @xmon = @mon
		set @xdriverno = @driverno
	end
	if(@cnt = 0)
	begin
		update @tmp set plusmoney = @totpmny where gno ='3' and mon = @xmon and driverno = @xdriverno
		update @tmp set minusmoney = @totmmny where gno ='3' and mon = @xmon and driverno = @xdriverno
	end	
	
	fetch next from cursor_table 
	into @mon,@driverno,@plusmoney,@minusmoney
end 
close cursor_table 
deallocate cursor_table

insert into @tmp(gno,mon,driverno,money)
select '4',mon,driverno,(money + plusmoney - minusmoney)
from @tmp where gno = '3'

insert into @tmp (gno,mon,driverno)
select '1',mon,driverno
from @tmp where gno ='3'

update @tmp set mon = SUBSTRING(mon,1,3) + '.' + SUBSTRING(mon,5,2) + '月份外車對帳明細單'

select gno,mon,driver,tel,trandate,po,carno,product,straddr,endaddr,mount,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,price),1)),4,15)) price,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,15)) money,
	   item,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plusmoney),1)),4,15)) plusmoney,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minusmoney),1)),4,15)) minusmoney,
	   memo
from @tmp order by mon,driverno,gno,trandate ;

-*******************************************************************************

z_tre_va02:--z_tre_va02

declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bdriverno = case when '#non'=[5] then '' else [5] end
set @t_edriverno = case when '#non'=[6] then char(255) else [6] end

---------------------------------------------------------------------------------

declare @tmp table(
	gno nvarchar(1),
	yymm nvarchar(30),
	bdate nvarchar(30),
	edate nvarchar(30),
	rno nvarchar(10),
	driverno nvarchar(20),
	driver nvarchar(20),
	money float,
	total float,
--	付款日期
--	付款方式
--	請款金額
	memo nvarchar(200)	
)

insert into @tmp
select '9',c.mon,min(c.trandate),max(c.trandate),'',a.driverno,a.driver,a.money,a.total,a.memo
from view_tre a
left join view_tres b on a.noa = b.noa  
left join view_trans c on b.tranno = c.noa and b.trannoq = c.noq
where (c.mon is not null) and (a.datea between @t_bdate and @t_edate) and (a.driverno between @t_bdriverno and @t_edriverno)
group by c.mon,a.driverno,a.driver,a.money,a.total,a.memo

insert into @tmp (gno,yymm,bdate,edate)
select '1',yymm,MIN(bdate),MAX(edate)
from @tmp where gno = '9' group by yymm

insert into @tmp (gno,yymm,driverno,driver,money,total)
select '0',yymm,driverno,driver,SUM(money),SUM(total)
from @tmp where gno = '9' group by yymm,driverno,driver

delete @tmp where gno = '9'

declare @i int
declare @cnt int
declare @yymm nvarchar(30)
declare @bdate nvarchar(30)
declare @edate nvarchar(30)

declare cursor_table cursor for 
select yymm,bdate,edate from @tmp where gno = '1'
open cursor_table 
fetch next from cursor_table 
into @yymm,@bdate,@edate
while(@@FETCH_STATUS <> -1) 
begin
	set @i = 0
	set @cnt = (select COUNT(*) from @tmp where gno = '0')
	
	while(@i < @cnt)
	begin
		update @tmp set bdate = @bdate where yymm = @yymm and gno = '0'
		update @tmp set edate = @edate where yymm = @yymm and gno = '0'
		
		set @i = @i + 1
	end
	
	
	fetch next from cursor_table 
	into @yymm,@bdate,@edate
end 
close cursor_table 
deallocate cursor_table


declare @driverno nvarchar(20)
declare @xyymm nvarchar(30)
set @xyymm = 'yymm'

declare cursor_table cursor for 
select yymm,driverno from @tmp where gno = '0'
open cursor_table 
fetch next from cursor_table 
into @yymm,@driverno
while(@@FETCH_STATUS <> -1) 
begin
	if(@yymm != @xyymm)
	begin
		set @i = 1
		update @tmp set rno = @i where yymm = @yymm and driverno = @driverno
		set @i = @i + 1
		set @xyymm = @yymm
	end
	else
	begin
		update @tmp set rno = @i where yymm = @yymm and driverno = @driverno
		set @i = @i + 1
		set @xyymm = @yymm
	end
	
	fetch next from cursor_table 
	into @yymm,@driverno
end 
close cursor_table 
deallocate cursor_table

delete @tmp where gno = '1'

insert into @tmp(gno,yymm,money,total)
select '1',yymm,SUM(money),SUM(total)
from @tmp where gno = '0' group by yymm

update @tmp set yymm = SUBSTRING(yymm,1,3) + '年' + SUBSTRING(yymm,5,2) + '外車運費支付明細'

select gno,yymm,('計算期間：' + bdate + '~' + edate) btoe ,rno,driver,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,15)) money,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,15)) total
from @tmp order by yymm,gno  ;