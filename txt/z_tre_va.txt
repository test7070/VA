z_tre_va01:--z_tre_va01

declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_bdate = case when '#non'=[3] then '' else [3] end
set @t_edate = case when '#non'=[4] then char(255) else [4] end
set @t_bdriverno = case when '#non'=[5] then '' else [5] end
set @t_edriverno = case when '#non'=[6] then char(255) else [6] end

---------------------------------------------------------------------------------

declare @tmp1 table(
	gno nvarchar(1),
	datea nvarchar(10),
	carno nvarchar(20),
	driverno nvarchar(20),
	driver nvarchar(20),
	bdate nvarchar(10),
	edate nvarchar(10)
)

insert into @tmp1 
select '0',SUBSTRING(datea,1,6),carno,driverno,driver,bdate,edate
from view_tre
where (datea between @t_bdate and @t_edate) and (driverno between @t_bdriverno and @t_edriverno)

insert into @tmp1 (gno,datea,carno,driverno,driver,bdate,edate)
select '1',datea,carno,driverno,driver,min(bdate),max(edate)
from @tmp1 where gno = '0' group by gno,datea,carno,driverno,driver

delete @tmp1 where gno = '0'


declare @tmp2 table(
	gno nvarchar(1),
	mon nvarchar(10),
	driverno nvarchar(20),
	driver nvarchar(20),
	tel nvarchar(20),
	trandate nvarchar(10),
	carno nvarchar(20),
	product nvarchar(40),
--  工程案號	
	straddr nvarchar(50),
	endaddr nvarchar(50),
--  重量/台
	price float,	
	money float,
	memo nvarchar(200)
)

declare @datea  nvarchar(10)
declare @carno nvarchar(20)
declare @driverno nvarchar(20)
declare @bdate nvarchar(10)
declare @edate nvarchar(10)

declare cursor_table cursor for 
select datea,carno,driverno,bdate,edate from @tmp1 where gno = '1'
open cursor_table 
fetch next from cursor_table 
into @datea,@carno,@driverno,@bdate,@edate
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmp2
	select '0','',a.noa,a.namea,
	case when LEN(a.tel) = 0 then a.mobile else a.tel end,
	b.trandate,'',b.product,b.straddr,b.endaddr,b.price,b.money,b.memo
	from driver a
	left join view_tres b on a.noa = b.driverno
	where(b.trandate between @bdate and @edate) and (b.driverno = @driverno)
	
	update @tmp2 set mon = @datea where (trandate between @bdate and @edate) and (driverno = @driverno)
	update @tmp2 set carno = @carno where (trandate between @bdate and @edate) and (driverno = @driverno)
		  
	fetch next from cursor_table 
	into @datea,@carno,@driverno,@bdate,@edate
end 
close cursor_table 
deallocate cursor_table

insert into @tmp2(gno,mon,driverno,driver,money)
select '1',mon,driverno,driver,SUM(money)
from @tmp2 where gno ='0' group by gno,mon,driverno,driver

update @tmp2 set trandate = 'zzzzzzzzz' where gno = '1'

select gno,SUBSTRING(mon,5,2) mon,driverno,driver,tel,trandate,carno,product,straddr,endaddr,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,price),1)),4,15)) price,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,15)) money,
	   memo 		
from @tmp2 order by mon,driverno,trandate,gno  ;
