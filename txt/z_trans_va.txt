z_trans_va01:--z_trans_va01

declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_carno nvarchar(20)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)


set @t_bmon = case when '#non'=[3] then '' else [3] end
set @t_emon = case when '#non'=[4] then char(255) else [4] end
set @t_bdate = case when '#non'=[5] then '' else [5] end
set @t_edate = case when '#non'=[6] then char(255) else [6] end
set @t_carno = case when '#non'=[7] then '' else [7] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then char(255) else [9] end
---------------------------------------------------------------------------------

declare @tmp1 table( 
gno nvarchar(1), 
yy nvarchar(10), 
mm nvarchar(10), 
driver nvarchar(20), 
trandate nvarchar(10), 
carno nvarchar(50), 
straddr nvarchar(max), 
endaddr nvarchar(max), 
pton2 decimal(18,3), 
total2 float, 
memo1 nvarchar(200), 
plusmoney float, 
minusmoney float, 
driverpay float, 
tmoney float 
) 

insert into @tmp1(gno,yy,mm,driver,trandate,carno,straddr,endaddr,pton2,a.total2,memo1) 
select '0','','',a.driver,a.trandate,a.carno,a.straddr,a.endaddr,a.pton2,a.total2,a.memo 
from view_trans a 
where (SUBSTRING(a.trandate,1,6) between @t_bmon and @t_emon) and 
(a.trandate between @t_bdate and @t_edate) and 
(LEN(@t_carno) = 0 or a.carno = @t_carno) and 
(a.driverno between @t_bdriverno and @t_edriverno) 
order by driver 

update @tmp1 set yy = SUBSTRING(trandate,1,3) 
update @tmp1 set mm = SUBSTRING(trandate,5,2) 

declare @tmp2 table( 
yy nvarchar(10), 
mm nvarchar(10),
driver nvarchar(20), 
plusmoney float, 
minusmoney float 
)  

insert into @tmp2 
select SUBSTRING(datea,1,3),SUBSTRING(datea,5,2),driver,SUM(plusmoney),SUM(minusmoney) 
from carchg 
where (SUBSTRING(datea,1,6) between @t_bmon and @t_emon) and 
(datea between @t_bdate and @t_edate) and 
(LEN(@t_carno) = 0 or carno = @t_carno) and 
(driverno between @t_bdriverno and @t_edriverno) 
group by SUBSTRING(datea,1,3),SUBSTRING(datea,5,2),driver order by driver

declare @tmp3 table(
yy nvarchar(10),
mm nvarchar(10),
driver nvarchar(20), 
driverpay float 
) 
insert into @tmp3 
select  SUBSTRING(datea,1,3),SUBSTRING(datea,5,2),driver,SUM(driverpay) 
from carborr 
where (SUBSTRING(datea,1,6) between @t_bmon and @t_emon) and 
(datea between @t_bdate and @t_edate) and 
(LEN(@t_carno) = 0 or carno = @t_carno) and 
(driverno between @t_bdriverno and @t_edriverno) 
group by  SUBSTRING(datea,1,3),SUBSTRING(datea,5,2),driver order by driver 

insert into @tmp1(gno,yy,mm,driver,total2) 
select '1',yy,mm,driver,SUM(total2) 
from @tmp1 group by yy,mm,driver 

declare @yy nvarchar(10)
declare @mm nvarchar(10)
declare @driver nvarchar(20) 

declare cursor_table cursor for 
select yy,mm,driver from @tmp1 order by driver 
open cursor_table 
fetch next from cursor_table 
into @yy,@mm,@driver 
while(@@FETCH_STATUS <> -1) 
begin 
update @tmp1 set plusmoney = (select plusmoney from @tmp2 where yy = @yy and mm=@mm and driver = @driver) where yy = @yy and mm=@mm and driver = @driver and gno ='1' 
update @tmp1 set minusmoney = (select minusmoney from @tmp2 where yy = @yy and mm=@mm and driver = @driver)where yy = @yy and mm=@mm and driver = @driver and gno ='1' 
update @tmp1 set driverpay = (select driverpay from @tmp3 where yy = @yy and mm=@mm and driver = @driver) where yy = @yy and mm=@mm and driver = @driver and gno ='1' 

if((select plusmoney from @tmp1 where yy = @yy and mm=@mm and driver = @driver and gno = '1') is null) 
begin 
update @tmp1 set plusmoney = 0 where yy = @yy and mm=@mm and driver = @driver and gno = '1' 
end 
if((select minusmoney from @tmp1 where yy = @yy and mm=@mm and driver = @driver and gno = '1') is null) 
begin 
update @tmp1 set minusmoney = 0 where yy = @yy and mm=@mm and driver = @driver and gno = '1' 
end 
if((select driverpay from @tmp1 where yy = @yy and mm=@mm and driver = @driver and gno = '1') is null) 
begin 
update @tmp1 set driverpay = 0 where yy = @yy and mm=@mm and driver = @driver and gno = '1' 
end 
fetch next from cursor_table 
into @yy,@mm,@driver
end 
close cursor_table 
deallocate cursor_table 

update @tmp1 set tmoney = total2 + plusmoney - minusmoney - driverpay where gno = '1' 

select * from @tmp1 order by driver,yy,mm,gno,trandate ;