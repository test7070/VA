z_trans_va01:--z_trans_va01

declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
declare @t_carno nvarchar(20)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)


set @t_bmon = case when '#non'=[3] then '' else [3] end
set @t_emon = case when '#non'=[4] then char(255) else [4] end
set @t_carno = case when '#non'=[7] then '' else [7] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then char(255) else [9] end
---------------------------------------------------------------------------------

declare @tmp1 table( 
	gno nvarchar(1), 
	yy nvarchar(10), 
	mm nvarchar(10), 
	driverno nvarchar(20), 
	driver nvarchar(20), 
	trandate nvarchar(10), 
	carno nvarchar(50), 
	straddr nvarchar(max), 
	endaddr nvarchar(max), 
	pton2 decimal(18,3), 
	total2 float, 
	memo nvarchar(200), 
	plusmoney float,
	minusmoney float, 
	driverpay float, 
	tmoney float 
) 

insert into @tmp1
select '0','','',a.driverno,a.driver,a.trandate,a.carno,a.straddr,a.endaddr,a.pton2,a.total2,a.memo,
       case when b.plus is null then 0 else b.plus end,
       case when b.labor is null then 0 else b.labor end +
       case when b.health is null then 0 else b.health end +
       case when b.ticket is null then 0 else b.ticket end +
       case when b.minus is null then 0 else b.minus end ,
       case when b.carborr is null then 0 else b.carborr end
       ,0
from view_trans a 
left join carsals b on (SUBSTRING(a.trandate,1,6) = b.noa) and (a.driver = b.driver)
where (SUBSTRING(a.trandate,1,6) between @t_bmon and @t_emon) and (LEN(@t_carno) = 0 or a.carno = @t_carno) and (a.driverno between @t_bdriverno and @t_edriverno)
	  
update @tmp1 set yy = SUBSTRING(trandate,1,3) 
update @tmp1 set mm = SUBSTRING(trandate,5,2) 

insert into @tmp1(gno,yy,mm,driverno,driver,total2,plusmoney,minusmoney,driverpay)
select '1',yy,mm,driverno,driver,SUM(total2),plusmoney,minusmoney,driverpay
from @tmp1 where gno = '0' group by yy,mm,driverno,driver,plusmoney,minusmoney,driverpay

update @tmp1 set tmoney = total2 + plusmoney - minusmoney - driverpay where gno = '1'

select gno,yy,mm,driverno,driver,trandate,carno,straddr,endaddr,pton2,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,15)) total2, 
	   memo, 
       reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plusmoney),1)),4,15)) plusmoney,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minusmoney),1)),4,15)) minusmoney,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverpay),1)),4,15)) driverpay,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tmoney),1)),4,15)) tmoney
from @tmp1 order by driverno,yy,mm,gno,trandate  ;



--******************************************************************************
z_trans_va02:--z_trans_va02

declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_bmon = case when '#non'=[3] then '' else [3] end
set @t_emon = case when '#non'=[4] then char(255) else [4] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then char(255) else [9] end

---------------------------------------------------------------------------------

declare @tmp1 table(
	gno nvarchar(1),
	trandate nvarchar(10),
	carno nvarchar(max),
	ranking int,
	driver nvarchar(20),
	tranmoney float,
	drivermoney float
--	memo nvarchar(max)
)


insert into @tmp1
select '9',SUBSTRING(a.trandate,1,6),a.carno,'',a.driver,a.total,a.total2 --,a.memo
from view_trans a
where (SUBSTRING(a.trandate,1,6) between @t_bmon and @t_emon) and (a.driverno between @t_bdriverno and @t_edriverno)
order by a.trandate,a.driverno

insert into @tmp1(gno,trandate,driver,tranmoney,drivermoney)
select '8',trandate,driver,SUM(tranmoney),SUM(drivermoney)
from @tmp1 where gno = '9' group by trandate,driver

insert into @tmp1(gno,trandate,ranking,driver,tranmoney,drivermoney)
select '0',trandate,DENSE_RANK() OVER(PARTITION BY trandate ORDER BY tranmoney DESC),driver,tranmoney,drivermoney
from @tmp1 where gno = '8' 
 
delete @tmp1 where gno = '8'

insert into @tmp1(gno,trandate,driver,carno,tranmoney,drivermoney)
select '1',trandate,driver,carno,SUM(tranmoney),SUM(drivermoney)
from @tmp1 where gno = '9' group by trandate,driver,carno

insert into @tmp1(gno,trandate,tranmoney,drivermoney)
select '2',trandate,SUM(tranmoney),SUM(drivermoney)
from @tmp1 where gno = '1' group by trandate

insert into @tmp1(gno,trandate,carno,tranmoney)
select '3' ,trandate,COUNT(*),SUM(tranmoney)
from @tmp1 where gno = '1' group by trandate

delete @tmp1 where gno = '9'


declare @trandate nvarchar(20)
declare @carno nvarchar(20)
declare @xdriver nvarchar(20)
declare @driver nvarchar(20)
declare @str nvarchar(max)
declare @recno int

set @xdriver = 'xxx'
set @str = ''

declare cursor_table cursor for 
select trandate,carno,driver from @tmp1 where gno = '1'
open cursor_table 
fetch next from cursor_table 
into @trandate,@carno,@driver
while(@@FETCH_STATUS <> -1) 
begin  
	 
	if(@driver != @xdriver)
	begin
		set @recno = (select COUNT(*) from @tmp1 where gno = '1' and driver = @driver and trandate = @trandate)
		set @str = @carno
		set @recno = @recno -1
		set @xdriver = @driver
	end
	else if((@driver = @xdriver) and (@recno > 0))
	begin
		set @str = @str + '.' + @carno
		set @recno = @recno -1
		set @xdriver = @driver
	end
	
	if(@recno = 0)
	begin
		update @tmp1 set carno = @str where gno = '0' and driver = @xdriver and trandate = @trandate
	end

	fetch next from cursor_table 
	into @trandate,@carno,@driver
end 
close cursor_table 
deallocate cursor_table 

declare @ranking int
declare @i int
declare @cnt int

declare cursor_table cursor for 
select trandate,ranking,driver from @tmp1 where gno = '0'
open cursor_table 
fetch next from cursor_table 
into @trandate,@ranking,@driver
while(@@FETCH_STATUS <> -1) 
begin
	set @i = 0
	set @cnt =(select COUNT(*) from @tmp1 where gno = '1' and driver = @driver and trandate = @trandate)
	
	while(@i < @cnt)
	begin
		update @tmp1 set ranking = @ranking where gno = '1' and driver = @driver and trandate = @trandate
		set @i = @i + 1
	end
	
	fetch next from cursor_table 
	into @trandate,@ranking,@driver
end 
close cursor_table 
deallocate cursor_table

update @tmp1 set trandate = SUBSTRING(trandate,1,3) + '.' + SUBSTRING(trandate,5,2) 
update @tmp1 set tranmoney = CEILING(tranmoney / carno) where gno = '3'
update @tmp1 set ranking = '999999999' where gno = '2' or gno = '3' 

select * from @tmp1 order by trandate,ranking,gno  ;



--******************************************************************************
z_trans_va03:--z_trans_va03

declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)

set @t_bmon = case when '#non'=[3] then '' else [3] end
set @t_emon = case when '#non'=[4] then char(255) else [4] end
set @t_bdriverno = case when '#non'=[8] then '' else [8] end
set @t_edriverno = case when '#non'=[9] then char(255) else [9] end

---------------------------------------------------------------------------------

declare @tmp table( 
	gno nvarchar(1), 
	mon nvarchar(50),  
	driverno nvarchar(20), 
	driver nvarchar(20),  
	drivermoney float, 
	plus float,
	money float,
	labheal float,
	ticket float,
	minus float, 
	borr float, 
	total float,
	memo nvarchar(1)
) 

insert into @tmp
select '0',a.noa,a.driverno,a.driver,a.drivermoney,a.plus,'0',a.labor + a.health,a.ticket,a.minus,a.carborr,0,a.memo
from carsals a
where (a.noa between @t_bmon and @t_emon)and (a.driverno between @t_bdriverno and @t_edriverno) 

update @tmp set mon = SUBSTRING(mon,1,3) + '.' +SUBSTRING(mon,5,2) + '月司機業績/實發金額明細表'

update @tmp set money = drivermoney + plus where gno = '0'
update @tmp set total = money - labheal - ticket - minus - borr where gno = '0'

insert into @tmp(gno,mon,drivermoney,plus,money,labheal,ticket,minus,borr,total)
select '1',mon,SUM(drivermoney),SUM(plus),SUM(money),SUM(labheal),SUM(ticket),SUM(minus),SUM(borr),SUM(total)
from @tmp where gno = '0' group by mon

select gno,mon,driverno,driver,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,15)) drivermoney, 
       reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,15)) plus,
       reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,15)) money,
       reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,labheal),1)),4,15)) labheal,
       reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,15)) ticket,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,15)) minus,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borr),1)),4,15)) borr,
	   reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,15)) total,
	   memo
from @tmp order by mon,gno ;




--******************************************************************************
z_trans_va05:--z_trans_va05

declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)

set @t_bmon = case when '#non'=[3] then '' else [3] end
set @t_emon = case when '#non'=[4] then char(255) else [4] end

---------------------------------------------------------------------------------